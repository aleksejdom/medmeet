'use client'\n\nimport { useState, useEffect, useRef } from 'react'\nimport { Button } from '@/components/ui/button'\nimport { Video, VideoOff, Mic, MicOff, Phone } from 'lucide-react'\nimport { supabase } from '@/lib/supabase'\nimport SimplePeer from 'simple-peer'\n\nexport default function VideoCall({ roomId, userId, userName, onLeave }) {\n  const [participants, setParticipants] = useState([])\n  const [localStream, setLocalStream] = useState(null)\n  const [remoteStream, setRemoteStream] = useState(null)\n  const [audioEnabled, setAudioEnabled] = useState(true)\n  const [videoEnabled, setVideoEnabled] = useState(true)\n  const [connectionStatus, setConnectionStatus] = useState('Connecting...')\n  \n  const localVideoRef = useRef(null)\n  const remoteVideoRef = useRef(null)\n  const peerRef = useRef(null)\n  const pollingIntervalRef = useRef(null)\n\n  useEffect(() => {\n    initializeCall()\n    return () => {\n      cleanup()\n    }\n  }, [])\n\n  const initializeCall = async () => {\n    try {\n      // Join room\n      await joinRoom()\n      \n      // Get local media stream\n      const stream = await navigator.mediaDevices.getUserMedia({\n        video: true,\n        audio: true\n      })\n      setLocalStream(stream)\n      if (localVideoRef.current) {\n        localVideoRef.current.srcObject = stream\n      }\n\n      // Check for other participants\n      await checkParticipants()\n      \n      // Start polling for signaling and participants\n      startPolling()\n    } catch (error) {\n      console.error('Failed to initialize call:', error)\n      setConnectionStatus('Failed to access camera/microphone')\n    }\n  }\n\n  const joinRoom = async () => {\n    const participantId = `participant_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n    await supabase.from('room_participants').insert([{\n      id: participantId,\n      room_id: roomId,\n      user_id: userId,\n      user_name: userName,\n      joined_at: new Date().toISOString(),\n      last_seen: new Date().toISOString()\n    }])\n  }\n\n  const checkParticipants = async () => {\n    const { data } = await supabase\n      .from('room_participants')\n      .select('*')\n      .eq('room_id', roomId)\n      .neq('user_id', userId)\n    \n    if (data && data.length > 0) {\n      setParticipants(data)\n      // If there's another participant, initiate connection\n      if (!peerRef.current) {\n        initiateConnection(true)\n      }\n    }\n  }\n\n  const updateLastSeen = async () => {\n    await supabase\n      .from('room_participants')\n      .update({ last_seen: new Date().toISOString() })\n      .eq('room_id', roomId)\n      .eq('user_id', userId)\n  }\n\n  const startPolling = () => {\n    // Poll for participants and signals every 2 seconds\n    pollingIntervalRef.current = setInterval(async () => {\n      await updateLastSeen()\n      await checkParticipants()\n      await checkForSignals()\n    }, 2000)\n  }\n\n  const initiateConnection = (isInitiator) => {\n    if (peerRef.current) return\n\n    setConnectionStatus(isInitiator ? 'Initiating connection...' : 'Waiting for peer...')\n\n    const peer = new SimplePeer({\n      initiator: isInitiator,\n      stream: localStream,\n      trickle: true\n    })\n\n    peer.on('signal', async (signal) => {\n      // Send signal to other peer via database\n      const signalId = `signal_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n      await supabase.from('webrtc_signals').insert([{\n        id: signalId,\n        room_id: roomId,\n        user_id: userId,\n        signal_type: signal.type === 'offer' ? 'offer' : signal.type === 'answer' ? 'answer' : 'ice-candidate',\n        signal_data: signal,\n        created_at: new Date().toISOString()\n      }])\n    })\n\n    peer.on('stream', (stream) => {\n      setRemoteStream(stream)\n      if (remoteVideoRef.current) {\n        remoteVideoRef.current.srcObject = stream\n      }\n      setConnectionStatus('Connected')\n    })\n\n    peer.on('connect', () => {\n      setConnectionStatus('Connected')\n    })\n\n    peer.on('error', (err) => {\n      console.error('Peer error:', err)\n      setConnectionStatus('Connection error')\n    })\n\n    peerRef.current = peer\n  }\n\n  const checkForSignals = async () => {\n    try {\n      const { data } = await supabase\n        .from('webrtc_signals')\n        .select('*')\n        .eq('room_id', roomId)\n        .neq('user_id', userId)\n        .order('created_at', { ascending: true })\n      \n      if (data && data.length > 0) {\n        for (const signal of data) {\n          if (peerRef.current) {\n            try {\n              peerRef.current.signal(signal.signal_data)\n            } catch (error) {\n              console.error('Error processing signal:', error)\n            }\n          } else if (signal.signal_type === 'offer') {\n            // We received an offer, create peer as non-initiator\n            initiateConnection(false)\n            setTimeout(() => {\n              if (peerRef.current) {\n                peerRef.current.signal(signal.signal_data)\n              }\n            }, 100)\n          }\n          \n          // Delete processed signal\n          await supabase\n            .from('webrtc_signals')\n            .delete()\n            .eq('id', signal.id)\n        }\n      }\n    } catch (error) {\n      console.error('Error checking signals:', error)\n    }\n  }\n\n  const toggleAudio = () => {\n    if (localStream) {\n      localStream.getAudioTracks().forEach(track => {\n        track.enabled = !track.enabled\n      })\n      setAudioEnabled(!audioEnabled)\n    }\n  }\n\n  const toggleVideo = () => {\n    if (localStream) {\n      localStream.getVideoTracks().forEach(track => {\n        track.enabled = !track.enabled\n      })\n      setVideoEnabled(!videoEnabled)\n    }\n  }\n\n  const cleanup = async () => {\n    // Stop polling\n    if (pollingIntervalRef.current) {\n      clearInterval(pollingIntervalRef.current)\n    }\n\n    // Close peer connection\n    if (peerRef.current) {\n      peerRef.current.destroy()\n    }\n\n    // Stop local stream\n    if (localStream) {\n      localStream.getTracks().forEach(track => track.stop())\n    }\n\n    // Remove from room\n    await supabase\n      .from('room_participants')\n      .delete()\n      .eq('room_id', roomId)\n      .eq('user_id', userId)\n    \n    // Clean up old signals\n    await supabase\n      .from('webrtc_signals')\n      .delete()\n      .eq('room_id', roomId)\n  }\n\n  const handleLeave = async () => {\n    await cleanup()\n    onLeave()\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-900 flex flex-col\">\n      {/* Header */}\n      <div className=\"bg-gray-800 border-b border-gray-700 p-4 flex items-center justify-between\">\n        <div className=\"flex items-center gap-2\">\n          <Video className=\"w-6 h-6 text-white\" />\n          <div>\n            <h2 className=\"text-white font-semibold\">Video Call</h2>\n            <p className=\"text-gray-400 text-sm\">{connectionStatus}</p>\n          </div>\n        </div>\n        <Button onClick={handleLeave} variant=\"destructive\" size=\"sm\">\n          <Phone className=\"w-4 h-4 mr-2\" />\n          Leave Call\n        </Button>\n      </div>\n      \n      {/* Video Grid */}\n      <div className=\"flex-1 flex items-center justify-center p-8\">\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-6xl\">\n          {/* Local Video */}\n          <div className=\"relative aspect-video bg-gray-800 rounded-lg overflow-hidden border-4 border-blue-500\">\n            <video\n              ref={localVideoRef}\n              autoPlay\n              muted\n              playsInline\n              className=\"w-full h-full object-cover\"\n            />\n            <div className=\"absolute bottom-4 left-4 bg-black bg-opacity-60 px-3 py-2 rounded-lg\">\n              <p className=\"text-white text-sm font-semibold\">{userName} (You)</p>\n              <p className=\"text-gray-300 text-xs\">\n                {videoEnabled ? 'Video Active' : 'Video Off'}\n              </p>\n            </div>\n            {!videoEnabled && (\n              <div className=\"absolute inset-0 flex items-center justify-center bg-gray-900\">\n                <VideoOff className=\"w-16 h-16 text-gray-500\" />\n              </div>\n            )}\n          </div>\n          \n          {/* Remote Video */}\n          <div className=\"relative aspect-video bg-gray-800 rounded-lg overflow-hidden\">\n            {remoteStream ? (\n              <>\n                <video\n                  ref={remoteVideoRef}\n                  autoPlay\n                  playsInline\n                  className=\"w-full h-full object-cover\"\n                />\n                <div className=\"absolute bottom-4 left-4 bg-black bg-opacity-60 px-3 py-2 rounded-lg\">\n                  <p className=\"text-white text-sm font-semibold\">\n                    {participants[0]?.user_name || 'Participant'}\n                  </p>\n                  <p className=\"text-gray-300 text-xs\">Connected</p>\n                </div>\n              </>\n            ) : (\n              <div className=\"flex items-center justify-center h-full\">\n                <div className=\"text-center\">\n                  <div className=\"w-24 h-24 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full mx-auto mb-4 flex items-center justify-center animate-pulse\">\n                    <Video className=\"w-12 h-12 text-white\" />\n                  </div>\n                  <p className=\"text-white text-lg font-semibold\">\n                    {participants.length > 0 ? participants[0].user_name : 'Waiting for participant'}\n                  </p>\n                  <p className=\"text-gray-400 text-sm mt-2\">\n                    {participants.length > 0 ? connectionStatus : 'Waiting to connect...'}\n                  </p>\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n      \n      {/* Controls */}\n      <div className=\"bg-gray-800 border-t border-gray-700 p-6\">\n        <div className=\"max-w-4xl mx-auto flex items-center justify-center gap-4\">\n          <Button\n            onClick={toggleAudio}\n            variant={audioEnabled ? 'secondary' : 'destructive'}\n            size=\"lg\"\n            className=\"rounded-full w-14 h-14\"\n          >\n            {audioEnabled ? <Mic className=\"w-6 h-6\" /> : <MicOff className=\"w-6 h-6\" />}\n          </Button>\n          \n          <Button\n            onClick={toggleVideo}\n            variant={videoEnabled ? 'secondary' : 'destructive'}\n            size=\"lg\"\n            className=\"rounded-full w-14 h-14\"\n          >\n            {videoEnabled ? <Video className=\"w-6 h-6\" /> : <VideoOff className=\"w-6 h-6\" />}\n          </Button>\n        </div>\n        \n        <div className=\"text-center mt-4\">\n          <p className=\"text-gray-400 text-sm\">Room ID: {roomId}</p>\n          <p className=\"text-gray-500 text-xs mt-1\">\n            Participants: {participants.length + 1}\n          </p>\n        </div>\n      </div>\n    </div>\n  )\n}\n